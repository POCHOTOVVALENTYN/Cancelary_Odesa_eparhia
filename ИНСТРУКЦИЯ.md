# Подробная инструкция по установке и использованию бота

## Содержание
1. [Требования](#требования)
2. [Установка](#установка)
3. [Настройка](#настройка)
4. [Запуск](#запуск)
5. [Использование](#использование)
6. [Добавление данных](#добавление-данных)
7. [Устранение неполадок](#устранение-неполадок)

## Требования

### Системные требования
- Операционная система: Windows, macOS или Linux
- Python версии 3.8 или выше
- Интернет-соединение
- Аккаунт в Telegram

### Необходимые знания
- Базовое понимание работы с командной строкой
- Умение редактировать текстовые файлы

## Установка

### Шаг 1: Проверка установки Python

Откройте терминал (командную строку) и выполните:

```bash
python --version
```

или

```bash
python3 --version
```

Должна отобразиться версия Python 3.8 или выше. Если Python не установлен:
- **Windows**: Скачайте с [python.org](https://www.python.org/downloads/)
- **macOS**: Установите через Homebrew: `brew install python3`
- **Linux**: `sudo apt-get install python3 python3-pip` (Ubuntu/Debian)

### Шаг 2: Переход в директорию проекта

```bash
cd /Users/valentin/Cancellary_Bot
```

### Шаг 3: Создание виртуального окружения

Виртуальное окружение изолирует зависимости проекта:

```bash
python3 -m venv venv
```

### Шаг 4: Активация виртуального окружения

**macOS/Linux:**
```bash
source venv/bin/activate
```

**Windows:**
```bash
venv\Scripts\activate
```

После активации в начале строки терминала появится `(venv)`.

### Шаг 5: Установка зависимостей

```bash
pip install -r requirements.txt
```

Это установит библиотеку `python-telegram-bot` и все необходимые зависимости.

## Настройка

### Шаг 1: Создание бота в Telegram

1. Откройте Telegram на вашем устройстве
2. Найдите бота **@BotFather** (официальный бот для создания ботов)
3. Отправьте команду `/newbot`
4. Следуйте инструкциям:
   - Введите имя бота (например: "Бот Одесской Епархии")
   - Введите username бота (должен заканчиваться на `bot`, например: `odessa_eparchy_bot`)
5. **Важно**: Скопируйте токен, который выдаст BotFather. Он выглядит примерно так:
   ```
   1234567890:ABCdefGHIjklMNOpqrsTUVwxyz1234567890
   ```

### Шаг 2: Настройка токена бота

**Способ 1: Через переменную окружения (рекомендуется)**

**macOS/Linux:**
```bash
export BOT_TOKEN="ваш_токен_здесь"
```

**Windows (PowerShell):**
```powershell
$env:BOT_TOKEN="ваш_токен_здесь"
```

**Windows (CMD):**
```cmd
set BOT_TOKEN=ваш_токен_здесь
```

**Способ 2: Прямое редактирование config.py**

Откройте файл `config.py` в текстовом редакторе и найдите строку:
```python
BOT_TOKEN = os.getenv("BOT_TOKEN", "YOUR_BOT_TOKEN_HERE")
```

Замените `"YOUR_BOT_TOKEN_HERE"` на ваш токен:
```python
BOT_TOKEN = os.getenv("BOT_TOKEN", "1234567890:ABCdefGHIjklMNOpqrsTUVwxyz")
```

### Шаг 3: Настройка администраторов

1. Узнайте свой Telegram ID:
   - Найдите бота **@userinfobot** в Telegram
   - Отправьте команду `/start`
   - Скопируйте ваш ID (число, например: `123456789`)

2. Откройте файл `config.py` и найдите:
   ```python
   ADMIN_IDS: List[int] = [
       # Добавьте сюда ID администраторов
   ]
   ```

3. Добавьте ваш ID:
   ```python
   ADMIN_IDS: List[int] = [
       123456789,  # Замените на ваш реальный ID
   ]
   ```

## Запуск

### Первый запуск

1. Убедитесь, что виртуальное окружение активировано (должно быть `(venv)` в начале строки)
2. Убедитесь, что токен настроен
3. Запустите бота:

```bash
python bot.py
```

Вы должны увидеть сообщения:
```
INFO - База данных инициализирована
INFO - Бот запущен и готов к работе!
```

### Добавление тестовых данных (опционально)

Для проверки работы бота можно добавить тестовые данные:

```bash
python add_sample_data.py
```

Это добавит 5 примеров священников в базу данных.

### Проверка работы

1. Откройте Telegram
2. Найдите вашего бота по username, который вы указали при создании
3. Отправьте команду `/start`
4. Бот должен ответить приветственным сообщением

## Использование

### Основные команды

#### `/start`
Приветствие и краткая инструкция по использованию бота.

#### `/help`
Подробная справка по всем доступным командам.

#### `/search <запрос>`
Поиск священника по имени или фамилии.

**Примеры:**
```
/search Иванов
/search Иван
/search Петр Петров
```

#### `/list`
Показывает список всех священников с пагинацией. Используйте кнопки "Назад" и "Вперёд" для навигации.

#### `/status <статус>`
Фильтр священников по статусу.

**Доступные статусы:**
- Протоиерей
- Иерей
- Диакон
- Протодиакон

**Примеры:**
```
/status протоиерей
/status иерей
/status диакон
```

### Простой поиск

Вы также можете просто отправить имя или фамилию в чат без команды `/search`, и бот выполнит поиск автоматически.

### Команды администратора

Эти команды доступны только пользователям, чьи ID указаны в `ADMIN_IDS`:

#### `/add`
Инструкция по добавлению нового священника (функция в разработке).

## Добавление данных

### Способ 1: Через Python-скрипт

Создайте файл `add_priest.py`:

```python
from datetime import date
from database import Database
from models import Priest

db = Database()

priest = Priest(
    name="Имя",
    surname="Фамилия",
    birth_date=date(1980, 1, 1),  # Год, месяц, день
    birth_place="Одесса",
    status="Протоиерей",  # Протоиерей, Иерей, Диакон, Протодиакон
    ordination_date=date(2005, 5, 15),
    service_place="Название храма",
    education="Название учебного заведения",
    last_reward="Название награды"
)

db.add_priest(priest)
print("Священник добавлен!")
```

Запустите:
```bash
python add_priest.py
```

### Способ 2: Через SQLite напрямую

1. Установите SQLite (обычно уже установлен):
   ```bash
   sqlite3 database.db
   ```

2. Выполните SQL-запрос:
   ```sql
   INSERT INTO priests (name, surname, birth_date, birth_place, status, ordination_date, service_place, education, last_reward)
   VALUES ('Имя', 'Фамилия', '1980-01-01', 'Одесса', 'Протоиерей', '2005-05-15', 'Храм', 'Семинария', 'Награда');
   ```

3. Выйдите: `.exit`

### Способ 3: Массовое добавление из CSV

Создайте файл `import_priests.py`:

```python
import csv
from datetime import datetime
from database import Database
from models import Priest

db = Database()

with open('priests.csv', 'r', encoding='utf-8') as f:
    reader = csv.DictReader(f)
    for row in reader:
        priest = Priest(
            name=row['name'],
            surname=row['surname'],
            birth_date=datetime.strptime(row['birth_date'], '%d.%m.%Y').date() if row['birth_date'] else None,
            birth_place=row['birth_place'],
            status=row['status'],
            ordination_date=datetime.strptime(row['ordination_date'], '%d.%m.%Y').date() if row['ordination_date'] else None,
            service_place=row['service_place'],
            education=row['education'],
            last_reward=row['last_reward']
        )
        db.add_priest(priest)

print("Импорт завершен!")
```

## Устранение неполадок

### Проблема: "ОШИБКА: Не установлен токен бота!"

**Решение:**
1. Проверьте, что токен установлен в переменной окружения или в `config.py`
2. Убедитесь, что токен скопирован полностью, без пробелов

### Проблема: Бот не отвечает на команды

**Решение:**
1. Проверьте, что бот запущен (должны быть логи в терминале)
2. Убедитесь, что вы пишете правильному боту (проверьте username)
3. Проверьте интернет-соединение

### Проблема: "ModuleNotFoundError: No module named 'telegram'"

**Решение:**
1. Убедитесь, что виртуальное окружение активировано
2. Переустановите зависимости: `pip install -r requirements.txt`

### Проблема: Ошибки при работе с базой данных

**Решение:**
1. Убедитесь, что у программы есть права на запись в директорию
2. Проверьте, что файл `database.db` не открыт в другой программе
3. Удалите `database.db` и перезапустите бота (база создастся заново)

### Проблема: Команды администратора не работают

**Решение:**
1. Проверьте, что ваш ID добавлен в `ADMIN_IDS` в `config.py`
2. Убедитесь, что ID указан правильно (число без кавычек)
3. Перезапустите бота после изменения `config.py`

## Автозапуск при загрузке системы

### macOS (используя launchd)

Создайте файл `~/Library/LaunchAgents/com.odessa.eparchy.bot.plist`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.odessa.eparchy.bot</string>
    <key>ProgramArguments</key>
    <array>
        <string>/Users/valentin/Cancellary_Bot/venv/bin/python</string>
        <string>/Users/valentin/Cancellary_Bot/bot.py</string>
    </array>
    <key>WorkingDirectory</key>
    <string>/Users/valentin/Cancellary_Bot</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>BOT_TOKEN</key>
        <string>ваш_токен</string>
    </dict>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
</dict>
</plist>
```

Загрузите:
```bash
launchctl load ~/Library/LaunchAgents/com.odessa.eparchy.bot.plist
```

### Linux (используя systemd)

См. раздел "Развертывание на сервере" в `README.md`.

## Безопасность

1. **Никогда не публикуйте токен бота** в открытых репозиториях
2. Используйте переменные окружения для хранения токена
3. Добавьте `config.py` в `.gitignore`, если храните токен там
4. Регулярно делайте резервные копии базы данных

## Резервное копирование

Для создания резервной копии базы данных:

```bash
cp database.db database_backup_$(date +%Y%m%d).db
```

Для восстановления:

```bash
cp database_backup_YYYYMMDD.db database.db
```

## Дополнительная помощь

Если у вас возникли проблемы, не описанные в этой инструкции:
1. Проверьте логи бота в терминале
2. Убедитесь, что все шаги установки выполнены правильно
3. Проверьте версию Python: `python --version`
