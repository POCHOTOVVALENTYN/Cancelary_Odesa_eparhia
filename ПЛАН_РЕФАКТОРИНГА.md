# План рефакторинга: Импорт данных из Excel

## Анализ задачи

### Текущая ситуация:
- Данные о священниках хранятся в Word документе
- Нужно преобразовать Word → Excel для удобства работы
- Необходимо добавить функциональность импорта Excel в базу данных бота

### Цели рефакторинга:
1. ✅ Создать инструмент для конвертации Word → Excel
2. ✅ Добавить модуль импорта данных из Excel
3. ✅ Реализовать команду в боте для импорта через Telegram
4. ✅ Добавить валидацию и обработку ошибок
5. ✅ Создать шаблон Excel для удобного заполнения

## Пошаговый план реализации

### Этап 1: Подготовка инфраструктуры

#### 1.1. Обновление зависимостей
- Добавить библиотеки для работы с Excel: `openpyxl` или `pandas`
- Добавить библиотеку для работы с Word: `python-docx` (опционально)
- Обновить `requirements.txt`

#### 1.2. Создание структуры модулей
- `excel_importer.py` - модуль для импорта из Excel
- `word_to_excel.py` - скрипт для конвертации Word → Excel
- `excel_template.py` - генератор шаблона Excel

### Этап 2: Конвертация Word → Excel

#### 2.1. Анализ структуры Word документа
- Определить формат данных в Word
- Выявить структуру таблиц/списков
- Создать парсер для извлечения данных

#### 2.2. Создание скрипта конвертации
- Скрипт `convert_word_to_excel.py`
- Извлечение данных из Word
- Преобразование в структурированный формат
- Сохранение в Excel с правильными колонками

#### 2.3. Валидация данных при конвертации
- Проверка обязательных полей
- Валидация дат
- Нормализация статусов

### Этап 3: Модуль импорта из Excel

#### 3.1. Создание `excel_importer.py`
- Класс `ExcelImporter` для работы с Excel файлами
- Методы:
  - `read_excel(file_path)` - чтение Excel файла
  - `validate_data(row)` - валидация строки
  - `import_to_database(file_path)` - импорт в БД
  - `get_import_statistics()` - статистика импорта

#### 3.2. Маппинг колонок Excel → модель Priest
- Гибкое сопоставление названий колонок
- Поддержка различных форматов Excel
- Обработка пустых ячеек

#### 3.3. Обработка ошибок
- Логирование проблемных строк
- Создание отчета об ошибках
- Частичный импорт (успешные записи сохраняются)

### Этап 4: Интеграция с ботом

#### 4.1. Обработчик файлов в Telegram
- Обработчик для получения Excel файлов
- Сохранение файла временно
- Вызов импорта

#### 4.2. Команда `/import`
- Команда для администраторов
- Инструкция по использованию
- Обработка процесса импорта

#### 4.3. Интерактивный режим импорта
- Подтверждение перед импортом
- Показ предпросмотра данных
- Выбор режима (добавить/обновить)

### Этап 5: Шаблон Excel

#### 5.1. Генератор шаблона
- Скрипт для создания пустого шаблона
- Правильные названия колонок
- Примеры данных
- Валидация на уровне Excel (опционально)

#### 5.2. Документация по шаблону
- Инструкция по заполнению
- Описание полей
- Примеры форматов дат

### Этап 6: Тестирование и документация

#### 6.1. Тестирование
- Тесты с различными форматами Excel
- Тесты валидации данных
- Тесты обработки ошибок

#### 6.2. Обновление документации
- Обновить README.md
- Добавить раздел в ИНСТРУКЦИЯ.md
- Создать примеры использования

## Структура Excel файла

### Предлагаемые колонки:

| Колонка | Описание | Обязательное | Формат |
|---------|----------|--------------|--------|
| Имя | Имя священника | ✅ Да | Текст |
| Фамилия | Фамилия священника | ✅ Да | Текст |
| Дата рождения | Дата рождения | ❌ Нет | DD.MM.YYYY |
| Место рождения | Место рождения | ❌ Нет | Текст |
| Статус | Статус священника | ✅ Да | Протоиерей/Иерей/Диакон/Протодиакон |
| Дата рукоположения | Дата рукоположения | ❌ Нет | DD.MM.YYYY |
| Место служения | Место служения | ❌ Нет | Текст |
| Образование | Место обучения | ❌ Нет | Текст |
| Последняя награда | Последняя награда | ❌ Нет | Текст |

### Альтернативные названия колонок (для гибкости):
- Имя / Name / Имя священника
- Фамилия / Surname / Фамилия священника
- Дата рождения / Birth Date / ДР
- И т.д.

## Реализация

### Приоритеты:
1. **Высокий**: Модуль импорта из Excel
2. **Высокий**: Команда `/import` в боте
3. **Средний**: Скрипт конвертации Word → Excel
4. **Средний**: Генератор шаблона Excel
5. **Низкий**: Расширенная валидация и отчеты

## Ожидаемые результаты

После реализации:
- ✅ Возможность импорта данных из Excel через бота
- ✅ Автоматическая валидация данных
- ✅ Отчеты об успешном/неуспешном импорте
- ✅ Шаблон Excel для заполнения
- ✅ Инструмент для конвертации Word → Excel

## Риски и решения

### Риск 1: Различные форматы Word документов
**Решение**: Создать универсальный парсер или предоставить инструкции по ручной конвертации

### Риск 2: Ошибки в данных Excel
**Решение**: Валидация каждой строки, логирование ошибок, частичный импорт

### Риск 3: Большие файлы Excel
**Решение**: Обработка по частям, показ прогресса, ограничение размера файла

## Временные оценки

- Этап 1: 30 минут
- Этап 2: 1-2 часа (зависит от формата Word)
- Этап 3: 2-3 часа
- Этап 4: 1-2 часа
- Этап 5: 30 минут
- Этап 6: 1 час

**Итого**: 6-9 часов работы
